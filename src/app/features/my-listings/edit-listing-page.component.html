<div class="edit-listing-page">
  <!-- Breadcrumbs -->
  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando artículo...</p>
    </div>
  } @else {
    <!-- Page Header -->
    <div class="page-header">
    <div class="container">
      <div class="header-info">
        <h1 class="page-title">
          {{ 'PAGES.EDIT_LISTING.SECTION_TITLE' | translate }}
        </h1>
      </div>
    </div>
  </div>

    <!-- Form Container -->
    <div class="form-container">
      <mat-card>
        <form [formGroup]="listingForm" (ngSubmit)="onSubmit()">
          
          <!-- Tipo de artículo -->
          <div class="form-section">
            <h2 class="section-title">Tipo de artículo</h2>
            <mat-button-toggle-group formControlName="type" class="type-toggle-group">
              <mat-button-toggle value="product" class="type-toggle-button">
                <div class="toggle-button-content">
                  <mat-icon>inventory_2</mat-icon>
                  <span>Producto</span>
                </div>
              </mat-button-toggle>
              <mat-button-toggle value="service" class="type-toggle-button">
                <div class="toggle-button-content">
                  <mat-icon>room_service</mat-icon>
                  <span>Servicio</span>
                </div>
              </mat-button-toggle>
            </mat-button-toggle-group>
            @if (listingForm.get('type')?.hasError('required') && listingForm.get('type')?.touched) {
              <div class="error-message">El tipo es requerido</div>
            }
          </div>

          <!-- Información básica -->
          <div class="form-section">
            <h2 class="section-title">Información básica</h2>
            
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Título</mat-label>
              <input matInput formControlName="title" placeholder="Ej: Notebook Lenovo IdeaPad 3">
              @if (listingForm.get('title')?.hasError('required') && listingForm.get('title')?.touched) {
                <mat-error>El título es requerido</mat-error>
              }
              @if (listingForm.get('title')?.hasError('minlength')) {
                <mat-error>El título debe tener al menos 5 caracteres</mat-error>
              }
              @if (listingForm.get('title')?.hasError('maxlength')) {
                <mat-error>El título no puede superar los 100 caracteres</mat-error>
              }
              <mat-hint align="end">{{listingForm.get('title')?.value?.length || 0}}/100</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Descripción corta</mat-label>
              <textarea matInput formControlName="short_description" rows="2" 
                placeholder="Breve descripción del artículo"></textarea>
              @if (listingForm.get('short_description')?.hasError('required') && listingForm.get('short_description')?.touched) {
                <mat-error>La descripción corta es requerida</mat-error>
              }
              @if (listingForm.get('short_description')?.hasError('minlength')) {
                <mat-error>Debe tener al menos 10 caracteres</mat-error>
              }
              @if (listingForm.get('short_description')?.hasError('maxlength')) {
                <mat-error>No puede superar los 200 caracteres</mat-error>
              }
              <mat-hint align="end">{{listingForm.get('short_description')?.value?.length || 0}}/200</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Descripción completa</mat-label>
              <textarea matInput formControlName="long_description" rows="6" 
                placeholder="Descripción detallada del artículo, características, etc."></textarea>
              @if (listingForm.get('long_description')?.hasError('required') && listingForm.get('long_description')?.touched) {
                <mat-error>La descripción completa es requerida</mat-error>
              }
              @if (listingForm.get('long_description')?.hasError('minlength')) {
                <mat-error>Debe tener al menos 20 caracteres</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Categoría</mat-label>
              <mat-select formControlName="category_id">
                @for (category of categories; track category.id) {
                  <mat-option [value]="category.id">{{ category.displayName || category.name }}</mat-option>
                }
              </mat-select>
              <mat-error>La categoría es requerida</mat-error>
            </mat-form-field>
          </div>

          <!-- Precios -->
          <div class="form-section">
            <h2 class="section-title">Precios</h2>
            
            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Precio</mat-label>
                <input matInput type="number" formControlName="price" placeholder="0">
                <span matTextPrefix>$&nbsp;</span>
                @if (listingForm.get('price')?.hasError('required') && listingForm.get('price')?.touched) {
                  <mat-error>El precio es requerido</mat-error>
                }
                @if (listingForm.get('price')?.hasError('min')) {
                  <mat-error>El precio debe ser mayor a 0</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Precio de lista (opcional)</mat-label>
                <input matInput type="number" formControlName="list_price" placeholder="0">
                <span matTextPrefix>$&nbsp;</span>
                <mat-hint>Para mostrar descuento (precio tachado)</mat-hint>
              </mat-form-field>
            </div>
          </div>

          <!-- Stock y cantidad -->        
          <div class="form-section">
            <h2 class="section-title">Stock y cantidad</h2>
            
            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Stock disponible</mat-label>
                <input matInput type="number" formControlName="stock_quantity" placeholder="0" min="0" max="10000">
                @if (listingForm.get('stock_quantity')?.hasError('min')) {
                  <mat-error>El stock no puede ser negativo</mat-error>
                }
                @if (listingForm.get('stock_quantity')?.hasError('max')) {
                  <mat-error>El stock no puede superar 10,000 unidades</mat-error>
                }
                <mat-hint>Cantidad de unidades disponibles (máx. 10,000)</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Cantidad máxima por pedido</mat-label>
                <input matInput type="number" formControlName="max_quantity_per_order" placeholder="1" min="1" max="10000">
                @if (listingForm.get('max_quantity_per_order')?.hasError('required')) {
                  <mat-error>Este campo es requerido</mat-error>
                }
                @if (listingForm.get('max_quantity_per_order')?.hasError('min')) {
                  <mat-error>Debe ser al menos 1</mat-error>
                }
                @if (listingForm.get('max_quantity_per_order')?.hasError('max')) {
                  <mat-error>No puede superar 10,000 unidades</mat-error>
                }
                <mat-hint>Máximo por cliente (máx. 10,000)</mat-hint>
              </mat-form-field>
            </div>
          </div>          

          <!-- Métodos de entrega (solo para productos) -->
          @if (isProduct) {
              <div class="form-section">
                <h2 class="section-title">Métodos de entrega</h2>
                <p class="section-description">Selecciona al menos un método de entrega</p>              
                <div class="delivery-methods">
                  @for (method of deliveryMethods; track method.id) {
                    <mat-checkbox 
                      [checked]="method.enabled"
                      (change)="toggleDeliveryMethod(method)"
                      class="delivery-method-checkbox">
                      <div class="delivery-method-info">
                        <span class="method-name">{{ method.name }}</span>
                        @if (method.description) {
                          <span class="method-description">{{ method.description }}</span>
                        }
                      </div>
                    </mat-checkbox>
                  }
                </div>
              </div>
          } @else {
            <div class="form-section">
              <h2 class="section-title">Método de entrega</h2>
              <div class="info-banner">
                <mat-icon class="info-icon">info</mat-icon>
                <span>Los servicios se consideran automáticamente como "Retiro en local"</span>
              </div>
            </div>
          }

          <!-- Imágenes -->
          <div class="form-section">
            <h2 class="section-title">Imágenes</h2>
            <p class="section-description">
              Sube hasta 5 imágenes. La primera será la imagen principal. Máximo 2MB por imagen.
            </p>
            <app-image-uploader 
              [maxImages]="5"
              [maxSizeInMB]="2"
              [existingImages]="existingImages"
              (imagesChanged)="onImagesChanged($event)">
            </app-image-uploader>
          </div>

          <!-- Visibilidad -->
          <div class="form-section">
            <h2 class="section-title">Visibilidad</h2>
            <p class="section-description">
              Configura la visibilidad de tu artículo en la tienda
            </p>
            
            <div class="visibility-options">
              <div class="visibility-option">
                <mat-slide-toggle formControlName="is_active" color="primary">
                  <div class="toggle-content">
                    <span class="toggle-label">Publicar artículo</span>
                    <span class="toggle-hint">
                      @if (listingForm.get('is_active')?.value) {
                        El artículo será visible en la tienda
                      } @else {
                        El artículo quedará como borrador
                      }
                    </span>
                  </div>
                </mat-slide-toggle>
              </div>

              <div class="visibility-option">
                <mat-slide-toggle formControlName="is_featured" color="accent">
                  <div class="toggle-content">
                    <span class="toggle-label">Destacar artículo</span>
                    <span class="toggle-hint">
                      @if (listingForm.get('is_featured')?.value) {
                        El artículo aparecerá en la sección destacados
                      } @else {
                        El artículo no será destacado
                      }
                    </span>
                  </div>
                </mat-slide-toggle>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button mat-stroked-button type="button" (click)="cancel()" [disabled]="isSubmitting()">
              Cancelar
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="isSubmitting()">
              @if (isSubmitting()) {
                <mat-spinner diameter="20"></mat-spinner>
                <span>Guardando...</span>
              } @else {
                <span>Guardar Cambios</span>
              }
            </button>
          </div>
        </form>
      </mat-card>
    </div>
  }
</div>