<div class="listing-detail-page">
  
  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <app-loading-spinner [message]="( 'COMMON.LOADING' | translate )" *ngIf="loading"></app-loading-spinner>

  <app-error-state 
    *ngIf="error && !loading"
    [title]="'LISTINGS.LOADING_ERROR' | translate"
    [message]="error"
    [retryButtonText]="'COMMON.RETRY' | translate"
    (retry)="handleRetry()">
  </app-error-state>

  <main *ngIf="listing && !loading && !error" class="listing-container">
    
    <div class="listing-content">
      
      <!-- Image Gallery -->
      <div class="gallery-section">
        <app-image-gallery 
          [images]="displayImages" 
          [title]="listing.title || ''">
        </app-image-gallery>
      </div>

      <!-- Listing Info -->
      <div class="listing-info">
        
        <div class="listing-category" *ngIf="listing.category">
          {{ listing.category.name || listing.category.slug }}
        </div>
        
        <h1 class="listing-title">{{ listing.title }}</h1>
        
        <div class="listing-inactive-msg" *ngIf="!listing.is_active">{{ 'LISTINGS.INACTIVE_MSG' | translate }}</div>

        <div class="listing-price" *ngIf="hasStock">
          <div class="price-original-wrapper">
            <span *ngIf="hasDiscount" class="price-original">
              ${{ formattedListPrice }}
            </span>
            <span *ngIf="hasDiscount" class="price-discount">
              -{{ discountPercentage }}%
            </span>
          </div>
          <div class="price-current">
            ${{ formattedPrice }}
          </div>
        </div>

        <div class="short-description" *ngIf="listing.short_description">
          <p>{{ listing.short_description }}</p>
        </div>

        <div class="listing-seller" *ngIf="listing.advertiser">
          <i class="fas fa-store"></i>
          {{ 'LISTINGS.SOLD_BY' | translate }}: <strong>{{ listing.advertiser.name }}</strong>
        </div>

        <!-- Stock Info -->
        <div class="stock-info" *ngIf="hasStock">
          <i class="fas fa-box"></i>
          {{ 'LISTINGS.STOCK_AVAILABLE' | translate }}: {{ listing.stock_quantity }} {{ 'LISTINGS.UNITS' | translate }}
        </div>        

        <!-- Sin Stock -->
        <div class="stock-info no-stock" *ngIf="!hasStock">
          <i class="fas fa-exclamation-circle"></i>
          {{ 'LISTINGS.OUT_OF_STOCK' | translate }}
        </div>

        <!-- Purchase Section -->
        <div class="purchase-section">
          <div class="purchase-wrapper" *ngIf="hasStock">
            <div class="quantity-selector">
              <span class="quantity-label">{{ 'LISTINGS.QUANTITY' | translate }}:</span>
              <div class="quantity-controls">
                <button 
                  class="quantity-btn" 
                  (click)="decreaseQuantity()"
                  [disabled]="quantity <= 1">
                  -
                </button>
                <input 
                  type="number" 
                  class="quantity-input no-spinner" 
                  [(ngModel)]="quantity"
                  [min]="1" 
                  [max]="maxAvailableQuantity">
                <button 
                  class="quantity-btn" 
                  (click)="increaseQuantity()"
                  [disabled]="quantity >= maxAvailableQuantity">
                  +
                </button>
              </div>
            </div>

            <div class="action-buttons">
              <button class="btn-purchase" (click)="purchase()">
                <i class="fas {{ 'LISTINGS.PURCHASE_ICON' | translate }}"></i>
                {{ 'LISTINGS.PURCHASE' | translate }}
              </button>
              <button class="btn-add-cart" (click)="addToCart()">
                <i class="fas {{ 'LISTINGS.ADD_TO_CART_ICON' | translate }}"></i>
                {{ 'LISTINGS.ADD_TO_CART' | translate }}
              </button>
              <button class="btn-wishlist" (click)="toggleWishlist()">
                <i class="far fa-heart"></i>
              </button>
            </div>
          </div>

          <!-- Delivery Methods -->
          <div class="delivery-info" *ngIf="listing.delivery_methods && listing.delivery_methods.length > 0">
            <div class="delivery-title">
              <i class="fas fa-truck"></i>
              {{ 'LISTINGS.DELIVERY_METHODS' | translate }}
            </div>
            <div class="delivery-methods">
              <div *ngFor="let method of listing.delivery_methods" class="delivery-method">
                <div class="method-name">
                  <i class="fas" [ngClass]="{'fa-store': method.type === 'pickup', 'fa-shipping-fast': method.type === 'delivery'}"></i>
                  {{ method.name }}
                </div>
                <div class="method-description" *ngIf="method.description">
                  {{ method.description }}
                </div>
                <div class="method-cost">
                  {{ getMethodCostDisplay(method.cost) }}
                </div>
                <div class="method-address" *ngIf="method.address">
                  <small>{{ method.address }}</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Default si no hay delivery methods -->
          <div class="shipping-info" *ngIf="!listing.delivery_methods || listing.delivery_methods.length === 0">
            <div class="shipping-title">
              <i class="fas fa-truck"></i>
              {{ 'LISTINGS.DELIVERY_METHODS' | translate }}
            </div>
            <div class="shipping-details">
              {{ 'LISTINGS.NO_DELIVERY_METHODS' | translate }}<br>
            </div>
          </div>

        </div>
        
      </div>
      
    </div>

    <!-- Full Description Section -->
    <section class="description-section" *ngIf="listing.long_description">
      <div class="section-container">
        <h2>{{ 'LISTINGS.DESCRIPTION_TITLE' | translate }}</h2>
        <div class="description-content">
          <p>{{ listing.long_description }}</p>
        </div>
      </div>
    </section>

    <!-- Related Products -->
    <section class="related-section" *ngIf="relatedListings.length > 0">
      <div class="section-container">
        <app-carousel title="{{ 'LISTINGS.RELATED' | translate }}">
          <app-listing-card 
            *ngFor="let relatedListing of relatedListings" 
            [listing]="relatedListing"
            (cardClick)="onRelatedListingClick($event)">
          </app-listing-card>
        </app-carousel>
      </div>
    </section>

  </main>
  
</div>