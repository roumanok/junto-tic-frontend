<div class="order-detail-page">

  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <app-loading-spinner [message]="( 'COMMON.LOADING' | translate )" *ngIf="loading()"></app-loading-spinner>

  <app-error-state 
    *ngIf="error() && !loading()"
    [title]="'PAGES.ORDER_DETAIL.LOADING_ERROR' | translate"
    [message]="error() || ( 'ERRORS.GENERAL' | translate )"
    [retryButtonText]="'COMMON.BACK' | translate"
    (retry)="goBack()">
  </app-error-state> 

  <!-- Payment Status Message -->
  <div *ngIf="paymentStatusMessage()" 
       class="payment-status-alert"
       [ngClass]="'alert-' + paymentStatusMessage()!.type">
    <div class="alert-content">
      <i class="fas" 
         [ngClass]="{
           'fa-check-circle': paymentStatusMessage()!.type === 'success',
           'fa-times-circle': paymentStatusMessage()!.type === 'error',
           'fa-exclamation-circle': paymentStatusMessage()!.type === 'warning'
         }"></i>
      <span>{{ paymentStatusMessage()!.text }}</span>
    </div>
  </div>

  <div *ngIf="order() && !loading()" class="order-detail-container">
    
    <div class="order-header">
      <div class="order-header-left">
        <h1>{{ "COMMON.ORDER" | translate }} #{{ order()!.public_id }}</h1>
        <p class="order-date">
          <i class="far fa-calendar"></i>
          {{ "PAGES.ORDER_DETAIL.CREATED_AT" | translate }} {{ formatDateTime(order()!.created_at) }}
        </p>
      </div>
      <div class="order-header-right">        
        <button class="btn btn-goback" (click)="goBack()">
          <i class="fas fa-arrow-left"></i> {{ 'COMMON.MY_ORDERS' | translate }}
        </button>
      </div>
    </div>

    <div class="status-cards">
      <div class="status-card" [ngClass]="'status-' + order()!.status">
        <div class="status-icon">
          <i class="fas fa-box"></i>
        </div>
        <div class="status-info">
          <span class="status-label">{{ 'PAGES.ORDER_DETAIL.STATUS' | translate }}</span>
          <span class="status-value">{{ getStatusLabel(order()!.status) }}</span>
        </div>
      </div>

      <div class="status-card status-card-with-button" [ngClass]="'payment-' + order()!.payment_status">
        <div class="status-content">
          <div class="status-icon">
            <i class="fas fa-credit-card"></i>
          </div>
          <div class="status-info">
            <span class="status-label">{{ 'PAGES.ORDER_DETAIL.PAYMENT_STATUS' | translate }}</span>
            <span class="status-value">{{ getPaymentStatusLabel(order()!.payment_status) }}</span>
          </div>
        </div>

        <button 
          *ngIf="shouldShowRetryButton()"
          class="btn-retry-payment"
          (click)="retryPayment(); $event.stopPropagation()"
          [disabled]="retryingPayment()"
        >
          <i class="fas" [ngClass]="retryingPayment() ? 'fa-spinner fa-spin' : 'fa-redo'"></i>
          {{ retryingPayment() ? ('PAGES.ORDER_DETAIL.RETRYING_PAYMENT' | translate) : ('PAGES.ORDER_DETAIL.RETRY_PAYMENT' | translate) }}
        </button>

        <button 
          *ngIf="shouldShowDownloadTicketButton()"
          class="btn-download-ticket"
          (click)="downloadTicket(); $event.stopPropagation()"          
        >
          <i class="fas fa-download"></i>
          {{ 'PAGES.ORDER_DETAIL.DOWNLOAD_TICKET' | translate }}
        </button>

      </div>

      <div class="status-card">
        <div class="status-icon">
          <i class="fas fa-truck"></i>
        </div>
        <div class="status-info">
          <span class="status-label">{{ 'PAGES.ORDER_DETAIL.DELIVERY_METHOD' | translate }}</span>
          <span class="status-value">{{ order()!.delivery_method.name }}</span>
        </div>
      </div>
    </div>

    <div class="order-content">
      
      <div class="order-info-wrapper">
    
      <div class="order-section">
        <h2><i class="fas fa-shopping-bag"></i> {{ "PAGES.ORDER_DETAIL.LISTINGS" | translate }}</h2>
        <div class="order-items">
          <div 
            *ngFor="let item of order()!.items" 
            class="order-item"
            (click)="goToListing(item.listing_id)"
          >
            <div class="item-image">
              <img 
                [src]="getCdnUrl(item.listing_image_url)" 
                [alt]="item.listing_title"
              />
            </div>
            <div class="item-details">
              <h3>{{ item.listing_title }}</h3>
              <p class="item-seller">
                <i class="fas fa-store"></i> {{ item.advertiser_name }}
              </p>
              <div class="item-pricing">
                <span class="item-quantity">{{ "PAGES.ORDER_DETAIL.QUANTITY" | translate }}: {{ item.quantity }}</span>
                <span class="item-unit-price">${{ formatPrice(item.unit_price) }} c/u</span>
              </div>
            </div>
            <div class="item-total">
              <span class="total-label">{{ "PAGES.ORDER_DETAIL.SUBTOTAL" | translate }}</span>
              <span class="total-value">${{ formatPrice(item.total_price) }}</span>
            </div>
          </div>
        </div>
      </div>      

      <div class="order-section order-summary">
        <h2><i class="fas fa-calculator"></i> {{ "PAGES.ORDER_DETAIL.SUMMARY" | translate }}</h2>
        <div class="summary-details">
          <div class="summary-row">
            <span>{{ "PAGES.ORDER_DETAIL.SUBTOTAL" | translate }}</span>
            <span>${{ formatPrice(order()!.subtotal) }}</span>
          </div>
          <div class="summary-row">
            <span>{{ "PAGES.ORDER_DETAIL.DELIVERY_COST" | translate }}</span>
            <span>${{ formatPrice(order()!.delivery_cost) }}</span>
          </div>
          <div class="summary-row summary-total">
            <span>{{ "PAGES.ORDER_DETAIL.TOTAL" | translate }}</span>
            <span>${{ formatPrice(order()!.total) }}</span>
          </div>
          <div *ngIf="order()!.paid_at" class="summary-row paid-info">
            <i class="fas fa-check-circle"></i>
            <span>{{ "PAGES.ORDER_DETAIL.PAID_AT" | translate }} {{ formatDateTime(order()!.paid_at) }}</span>
          </div>
        </div>
      </div>

      </div>

      <div class="order-section">
        <h2>
          <i class="fas fa-{{ order()!.delivery_method_type === 'delivery' ? 'shipping-fast' : 'store' }}"></i>
          {{ "PAGES.ORDER_DETAIL.DELIVERY_INFORMATION" | translate }}
        </h2>
        <div class="info-grid">
          <div *ngIf="order()!.delivery_method_type === 'delivery'" class="info-block">
            <h3>{{ order()!.delivery_method.name }}</h3>
            <p>{{ order()!.delivery_method.description }}</p>
            <br>
            <h3>{{ "PAGES.ORDER_DETAIL.CONTACT_INFORMATION" | translate }}</h3>
            <p class="capitalize"><strong>{{ "PAGES.ORDER_DETAIL.DELIVERY_NAME" | translate }}:</strong> {{ order()!.delivery_name }}</p>
            <p><strong>{{ "PAGES.ORDER_DETAIL.DELIVERY_PHONE" | translate }}:</strong> ({{ order()!.delivery_phone_area_code }}){{ order()!.delivery_phone_number }}</p>
          </div>
          <div *ngIf="order()!.delivery_method_type === 'delivery'" class="info-block">
            <h3>{{ "PAGES.ORDER_DETAIL.DELIVERY_ADDRESS" | translate }}</h3>
            <p class="capitalize">{{ order()!.delivery_address }}</p>
            <p *ngIf="order()!.delivery_apartment">{{ order()!.delivery_apartment }}</p>
            <p class="capitalize">{{ order()!.delivery_city }}, {{ order()!.delivery_province }}</p>
            <p>{{ "PAGES.ORDER_DETAIL.POSTAL_CODE" | translate }}: {{ order()!.delivery_postal_code }}</p>
            <p *ngIf="order()!.delivery_notes" class="delivery-notes">
              <strong>{{ "PAGES.ORDER_DETAIL.DELIVERY_NOTES" | translate }}:</strong> {{ order()!.delivery_notes }}
            </p>
          </div>
          <div *ngIf="order()!.delivery_method_type === 'pickup'" class="info-block">
            <h3>{{ order()!.delivery_method.name }}</h3>            
            <p class="pickup-description">
              {{ order()!.delivery_method.description }}
            </p>
            <p class="pickup-location">
              <strong>{{ "PAGES.ORDER_DETAIL.PICKUP_LOCATION" | translate }}:</strong> {{ order()!.delivery_method.address }}
            </p>
          </div>
        </div>
      </div>
      
      <div class="order-section">
        <h2><i class="fas fa-file-invoice"></i>{{ "PAGES.ORDER_DETAIL.BILLING_INFORMATION" | translate }}</h2>
        <div class="info-grid">
          <div class="info-block">
            <h3>{{ "PAGES.ORDER_DETAIL.CUSTOMER_INFORMATION" | translate }}</h3>
            <p class="capitalize"><strong>{{ "PAGES.ORDER_DETAIL.BILLING_NAME" | translate }}:</strong> {{ order()!.billing_name }}</p>
            <p><strong>{{ "PAGES.ORDER_DETAIL.BILLING_PHONE" | translate }}:</strong> ({{ order()!.billing_phone_area_code }}){{ order()!.billing_phone_number }}</p>
            <p><strong>{{ "PAGES.ORDER_DETAIL.CUSTOMER_IDENTIFICATION_TYPE" | translate }}:</strong>{{ getCustomerIdentificationTypeLabel(order()!.customer_identification_type) }}</p>
            <p><strong>{{ "PAGES.ORDER_DETAIL.CUSTOMER_IDENTIFICATION_NUMBER" | translate }}:</strong>{{ order()!.customer_identification_number }}</p>
          </div>
          <div class="info-block">
            <h3>{{ "PAGES.ORDER_DETAIL.BILLING_ADDRESS" | translate }}</h3>
            <p class="capitalize">{{ order()!.billing_address }}</p>
            <p *ngIf="order()!.billing_apartment">{{ order()!.billing_apartment }}</p>
            <p class="capitalize">{{ order()!.billing_city }}, {{ order()!.billing_province }}</p>
            <p>{{ "PAGES.ORDER_DETAIL.POSTAL_CODE" | translate }}: {{ order()!.billing_postal_code }}</p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>