<div class="checkout-wrapper">
  @if (!product()) {
    
    <app-error-state     
      [title]="'PAGES.CHECKOUT.NO_LISTING' | translate"
      [message]="'PAGES.CHECKOUT.NO_LISTING_DESC' | translate"
      [retryButtonText]="'COMMON.BACK' | translate"
      (retry)="goBack()">
    </app-error-state> 
    
  } @else {

    <div class="checkout-container">
      
      <div class="checkout-left">
        <div class="summary-card">
          <h2>{{ 'PAGES.CHECKOUT.SUMMARY' | translate }}</h2>
          
          <div class="product-item">
            <img [src]="getCdnUrl(product()!.image_url)" [alt]="product()!.title" class="product-img">
            <div class="product-details">
              <h3>{{ product()!.title }}</h3>
              <p class="product-price">$ {{ getformattedPrice(product()!.price) }}</p>
                            
              <div class="quantity-section">
                <label>{{ 'PAGES.CHECKOUT.QUANTITY' | translate }}</label>
                <div class="quantity-controls">
                  <button type="button" class="qty-btn" (click)="decreaseQuantity()" [disabled]="quantity() <= 1">
                    -
                  </button>
                  <input type="number" 
                         [value]="quantity()" 
                         (change)="updateQuantity($event)" 
                         [max]="getMaxQuantity()"
                         min="1" 
                         class="qty-input no-spinner">
                  <button type="button" class="qty-btn" (click)="increaseQuantity()" [disabled]="quantity() >= getMaxQuantity()">
                    +
                  </button>
                </div>
              </div>
            </div>
          </div>

          @if (product()!.delivery_methods && product()!.delivery_methods!.length > 0) {
            <div class="delivery-section">
              <h4>{{ 'PAGES.CHECKOUT.DELIVERY_METHOD' | translate }}:</h4>
              <div class="delivery-methods">
                @for (method of product()!.delivery_methods; track method.id) {
                  <label class="delivery-option">
                    <input type="radio" 
                           name="delivery_method"
                           [value]="method.id"
                           [checked]="selectedDeliveryMethod() === method.id"
                           (change)="onDeliveryMethodChange(method.id)">
                    <div class="method-content">
                      <div class="method-header">
                        <div class="method-left">
                          <i class="fas" [ngClass]="method.type === 'pickup' ? 'fa-store' : 'fa-truck'"></i>
                          <span class="method-name">{{ method.name }}</span>
                        </div>
                        <span class="method-cost">
                          {{ getMethodCost(method.cost) === 0 ? ('PAGES.CHECKOUT.FREE' | translate) : ('$ ' + getformattedPrice(method.cost)) }}
                        </span>
                      </div>
                      @if (method.description) {
                        <p class="method-desc">{{ method.description }}</p>
                      }
                      @if (method.address) {
                        <p class="method-addr">{{ method.address }}</p>
                      }
                    </div>
                  </label>
                }
              </div>
            </div>
          }

          <hr class="divider">

          <div class="totals">
            <div class="total-row">
              <span>{{'PAGES.CHECKOUT.SUBTOTAL' | translate}}:</span>
              <span>$ {{ getformattedPrice(totals()?.subtotal || product()!.price) }}</span>
            </div>
            <div class="total-row">
              <span>{{ 'PAGES.CHECKOUT.SHIPPING' | translate }}:</span>
              <span>
                @if (totals()?.shipping && getMethodCost(totals()!.shipping) > 0) {
                  $ {{ getformattedPrice(totals()!.shipping) }}
                } @else {
                  <strong class="free">{{ 'PAGES.CHECKOUT.FREE' | translate }}</strong>
                }
              </span>
            </div>
            <div class="total-row total-final">
              <span><strong>{{ 'PAGES.CHECKOUT.TOTAL' | translate }}:</strong></span>
              <span><strong>$ {{ getformattedPrice(totals()?.total || (getMethodCost(product()!.price) * quantity()).toString()) }}</strong></span>
            </div>
          </div>
        </div>
      </div>

      <div class="checkout-right">
        
        <div class="data-card">                    
          <form [formGroup]="checkoutForm" class="checkout-form">

            <h2>{{ 'PAGES.CHECKOUT.CONTACT_DATA' | translate }}</h2>

            <div class="form-row">                            
              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>{{ 'PAGES.CHECKOUT.CUSTOMER_EMAIL' | translate }}</mat-label>
                <input matInput formControlName="customer_email" readonly>
                <mat-icon matPrefix>email</mat-icon>
              </mat-form-field>
            </div>

            @if (!isPickupMethod()) {

              <h2>{{ 'PAGES.CHECKOUT.DELIVERY_DATA' | translate }}</h2>

              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field full-width">
                  <mat-label>{{ 'PAGES.CHECKOUT.DELIVERY_NAME' | translate }}</mat-label>
                  <input matInput formControlName="delivery_name" autocomplete="name">
                  <mat-icon matPrefix>person</mat-icon>
                  <mat-error *ngIf="checkoutForm.get('delivery_name')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.DELIVERY_NAME_REQUIRED' | translate }}
                  </mat-error>
                  <mat-error *ngIf="checkoutForm.get('delivery_name')?.hasError('minlength')">
                    {{ 'PAGES.CHECKOUT.DELIVERY_NAME_MIN_LENGTH' | translate }}                  
                  </mat-error>
                </mat-form-field>              
              </div>

              <!-- Teléfono -->
              <div class="phone-group" style="display: grid; grid-template-columns: 100px 100px 1fr; gap: 0.5rem;">
                <mat-form-field appearance="outline" class="form-field">                  
                  <input matInput value="{{ 'PAGES.CHECKOUT.DELIVERY_PHONE_COUNTRY_CODE' | translate }}" readonly disabled="true">
                  <mat-icon matPrefix>phone</mat-icon>                  
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>{{ 'PAGES.CHECKOUT.DELIVERY_PHONE_AREA_CODE' | translate }}</mat-label>
                  <input matInput formControlName="delivery_phone_area_code" placeholder="11" required maxlength="4" autocomplete="tel-area-code">
                  <mat-error *ngIf="checkoutForm.get('delivery_phone_area_code')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.DELIVERY_PHONE_AREA_CODE_REQUIRED' | translate }}
                  </mat-error>
                  <mat-error *ngIf="checkoutForm.get('delivery_phone_area_code')?.hasError('pattern')">
                    {{ 'PAGES.CHECKOUT.DELIVERY_PHONE_AREA_CODE_PATTERN' | translate }}
                  </mat-error>
                </mat-form-field>
                
                <mat-form-field appearance="outline">
                  <mat-label>{{ 'PAGES.CHECKOUT.DELIVERY_PHONE_NUMBER' | translate }}</mat-label>
                  <input matInput formControlName="delivery_phone_number" required maxlength="8" autocomplete="tel-local">
                  <mat-error *ngIf="checkoutForm.get('delivery_phone_number')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.DELIVERY_PHONE_NUMBER_REQUIRED' | translate }}
                  </mat-error>
                  <mat-error *ngIf="checkoutForm.get('delivery_phone_number')?.hasError('pattern')">
                    {{ 'PAGES.CHECKOUT.DELIVERY_PHONE_NUMBER_PATTERN' | translate }}
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- Dirección -->
              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>{{ 'PAGES.CHECKOUT.DELIVERY_ADDRESS' | translate }}</mat-label>
                <input matInput formControlName="delivery_address" autocomplete="street-address">
                <mat-icon matPrefix>home</mat-icon>
                <mat-error *ngIf="checkoutForm.get('delivery_address')?.hasError('required')">
                  {{ 'PAGES.CHECKOUT.DELIVERY_ADDRESS_REQUIRED' | translate }}
                </mat-error>
                <mat-error *ngIf="checkoutForm.get('delivery_address')?.hasError('minlength')">
                  {{ 'PAGES.CHECKOUT.DELIVERY_ADDRESS_MIN_LENGTH' | translate }}
                </mat-error>
              </mat-form-field>

              <!-- Depto/Piso y Código Postal -->
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>{{ 'PAGES.CHECKOUT.DELIVERY_APARTMENT' | translate }}</mat-label>
                  <input matInput formControlName="delivery_apartment" autocomplete="address-line2">
                  <mat-icon matPrefix>apartment</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>{{ 'PAGES.CHECKOUT.DELIVERY_POSTAL_CODE' | translate }}</mat-label>
                  <input matInput formControlName="delivery_postal_code" autocomplete="postal-code">
                  <mat-icon matPrefix>markunread_mailbox</mat-icon>
                  <mat-error *ngIf="checkoutForm.get('delivery_postal_code')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.DELIVERY_POSTAL_CODE_REQUIRED' | translate }}
                  </mat-error>
                  <mat-error *ngIf="checkoutForm.get('delivery_postal_code')?.hasError('pattern')">
                    {{ 'PAGES.CHECKOUT.DELIVERY_POSTAL_CODE_PATTERN' | translate }}                  
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- Ciudad y Provincia -->
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>{{ 'PAGES.CHECKOUT.DELIVERY_CITY' | translate }}</mat-label>
                  <input matInput formControlName="delivery_city" autocomplete="address-level2">
                  <mat-icon matPrefix>location_city</mat-icon>
                  <mat-error *ngIf="checkoutForm.get('delivery_city')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.DELIVERY_CITY_REQUIRED' | translate }}
                  </mat-error>                
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>{{ 'PAGES.CHECKOUT.DELIVERY_PROVINCE' | translate }}</mat-label>
                  <mat-select formControlName="delivery_province">
                    <mat-option *ngFor="let province of provinces" [value]="province">
                      {{ province }}
                    </mat-option>
                  </mat-select>
                  <mat-icon matPrefix>map</mat-icon>
                  <mat-error *ngIf="checkoutForm.get('delivery_province')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.DELIVERY_PROVINCE_REQUIRED' | translate }}
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- Notas adicionales -->
              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>{{ 'PAGES.CHECKOUT.DELIVERY_NOTES' | translate }}</mat-label>
                <textarea matInput 
                          formControlName="delivery_notes" 
                          rows="3"></textarea>
                <mat-icon matPrefix>note</mat-icon>
                <mat-error *ngIf="checkoutForm.get('delivery_notes')?.hasError('maxlength')">
                  {{ 'PAGES.CHECKOUT.DELIVERY_NOTES_MAX_LENGTH' | translate }}                
                </mat-error>
              </mat-form-field>

            }

            <h2>{{ 'PAGES.CHECKOUT.BILLING_DATA' | translate }}</h2>

            <!-- Tipo y Número de documento -->
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>{{ 'PAGES.CHECKOUT.CUSTOMER_IDENTIFICATION_TYPE' | translate }}</mat-label>
                <mat-select formControlName="customer_identification_type">
                  <mat-option value="DNI_ARG">{{ 'COMMON.DNI' | translate }}</mat-option>
                  <mat-option value="CUIT_ARG">{{ 'COMMON.CUIT' | translate }}</mat-option>                  
                </mat-select>
                <mat-icon matPrefix>badge</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>{{ 'PAGES.CHECKOUT.CUSTOMER_IDENTIFICATION_NUMBER' | translate }}</mat-label>
                <input matInput formControlName="customer_identification_number">
                <mat-icon matPrefix>fingerprint</mat-icon>
                <mat-error *ngIf="checkoutForm.get('customer_identification_number')?.hasError('required')">
                  {{ 'PAGES.CHECKOUT.CUSTOMER_IDENTIFICATION_NUMBER_REQUIRED' | translate }}
                </mat-error>
                <mat-error *ngIf="checkoutForm.get('customer_identification_number')?.hasError('pattern')">
                  {{ 'PAGES.CHECKOUT.CUSTOMER_IDENTIFICATION_NUMBER_PATTERN' | translate }}
                </mat-error>
              </mat-form-field>
            </div>      

            @if (!isPickupMethod()) {
              <div class="form-field full-width checkbox-section">
                <mat-checkbox 
                  [checked]="sameAsDelivery()"
                  (change)="toggleSameAsDelivery($event.checked)">
                  {{ 'PAGES.CHECKOUT.BILLING_INHERITS' | translate }}
                </mat-checkbox>
              </div>
            }

            @if (!sameAsDelivery() || isPickupMethod()) {            
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field full-width">
                  <mat-label>{{ 'PAGES.CHECKOUT.BILLING_NAME' | translate }}</mat-label>
                  <input matInput formControlName="billing_name" autocomplete="name">
                  <mat-icon matPrefix>person</mat-icon>
                  <mat-error *ngIf="checkoutForm.get('billing_name')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.BILLING_NAME_REQUIRED' | translate }}
                  </mat-error>
                  <mat-error *ngIf="checkoutForm.get('billing_name')?.hasError('minlength')">
                    {{ 'PAGES.CHECKOUT.BILLING_NAME_MIN_LENGTH' | translate }}                  
                  </mat-error>
                </mat-form-field>              
              </div>

              <!-- Teléfono -->
              <div class="phone-group" style="display: grid; grid-template-columns: 100px 100px 1fr; gap: 0.5rem;">
                <mat-form-field appearance="outline" class="form-field">                  
                  <input matInput value="{{ 'PAGES.CHECKOUT.BILLING_PHONE_COUNTRY_CODE' | translate }}" readonly disabled="true">
                  <mat-icon matPrefix>phone</mat-icon>                  
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>{{ 'PAGES.CHECKOUT.BILLING_PHONE_AREA_CODE' | translate }}</mat-label>
                  <input matInput formControlName="billing_phone_area_code" placeholder="11" required maxlength="4" autocomplete="tel-area-code">
                  <mat-error *ngIf="checkoutForm.get('billing_phone_area_code')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.BILLING_PHONE_AREA_CODE_REQUIRED' | translate }}
                  </mat-error>
                  <mat-error *ngIf="checkoutForm.get('billing_phone_area_code')?.hasError('pattern')">
                    {{ 'PAGES.CHECKOUT.BILLING_PHONE_AREA_CODE_PATTERN' | translate }}
                  </mat-error>
                </mat-form-field>
                
                <mat-form-field appearance="outline">
                  <mat-label>{{ 'PAGES.CHECKOUT.BILLING_PHONE_NUMBER' | translate }}</mat-label>
                  <input matInput formControlName="billing_phone_number" required maxlength="8" autocomplete="tel-local">
                  <mat-error *ngIf="checkoutForm.get('delivery_phone_number')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.BILLING_PHONE_NUMBER_REQUIRED' | translate }}
                  </mat-error>
                  <mat-error *ngIf="checkoutForm.get('billing_phone_number')?.hasError('pattern')">
                    {{ 'PAGES.CHECKOUT.BILLING_PHONE_NUMBER_PATTERN' | translate }}
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- Dirección -->
              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>{{ 'PAGES.CHECKOUT.BILLING_ADDRESS' | translate }}</mat-label>
                <input matInput formControlName="billing_address" autocomplete="street-address">
                <mat-icon matPrefix>home</mat-icon>
                <mat-error *ngIf="checkoutForm.get('billing_address')?.hasError('required')">
                  {{ 'PAGES.CHECKOUT.BILLING_ADDRESS_REQUIRED' | translate }}
                </mat-error>
                <mat-error *ngIf="checkoutForm.get('billing_address')?.hasError('minlength')">
                  {{ 'PAGES.CHECKOUT.BILLING_ADDRESS_MIN_LENGTH' | translate }}
                </mat-error>
              </mat-form-field>

              <!-- Depto/Piso y Código Postal -->
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>{{ 'PAGES.CHECKOUT.BILLING_APARTMENT' | translate }}</mat-label>
                  <input matInput formControlName="billing_apartment" autocomplete="address-line2">
                  <mat-icon matPrefix>apartment</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>{{ 'PAGES.CHECKOUT.BILLING_POSTAL_CODE' | translate }}</mat-label>
                  <input matInput formControlName="billing_postal_code" autocomplete="postal-code">
                  <mat-icon matPrefix>markunread_mailbox</mat-icon>
                  <mat-error *ngIf="checkoutForm.get('billing_postal_code')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.BILLING_POSTAL_CODE_REQUIRED' | translate }}
                  </mat-error>
                  <mat-error *ngIf="checkoutForm.get('billing_postal_code')?.hasError('pattern')">
                    {{ 'PAGES.CHECKOUT.BILLING_POSTAL_CODE_PATTERN' | translate }}                  
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- Ciudad y Provincia -->
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>{{ 'PAGES.CHECKOUT.BILLING_CITY' | translate }}</mat-label>
                  <input matInput formControlName="billing_city" autocomplete="address-level2">
                  <mat-icon matPrefix>location_city</mat-icon>
                  <mat-error *ngIf="checkoutForm.get('billing_city')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.BILLING_CITY_REQUIRED' | translate }}
                  </mat-error>                
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>{{ 'PAGES.CHECKOUT.BILLING_PROVINCE' | translate }}</mat-label>
                  <mat-select formControlName="billing_province">
                    <mat-option *ngFor="let province of provinces" [value]="province">
                      {{ province }}
                    </mat-option>
                  </mat-select>
                  <mat-icon matPrefix>map</mat-icon>
                  <mat-error *ngIf="checkoutForm.get('billing_province')?.hasError('required')">
                    {{ 'PAGES.CHECKOUT.BILLING_PROVINCE_REQUIRED' | translate }}
                  </mat-error>
                </mat-form-field>
              </div>            
            }

            <!-- Botones de acción -->
            <div class="action-buttons">
              <button type="button" class="btn-goback" (click)="goBack()">
                <i class="fas fa-arrow-left"></i>
                {{ 'PAGES.CHECKOUT.CONTINUE_SHOPPING' | translate }}
              </button>
              <button type="button" 
                      class="btn-payment" 
                      (click)="proceedToPayment()"
                      [disabled]="!canProceed() || !formValid()">
                <i class="fas fa-credit-card"></i>
                {{ 'PAGES.CHECKOUT.CONTINUE_PAYMENT' | translate }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Estados de carga -->
    @if (validating() || calculating()) {
      <div class="loading-overlay">
        <div class="spinner"></div>
        <p>{{ validating() ? ('PAGES.CHECKOUT.VALIDATING' | translate) : ('PAGES.CHECKOUT.CALCULATING_TOTALS' | translate) }}</p>
      </div>
    }

    <!-- Errores de validación -->
    @if (validationErrors().length > 0) {
      <div class="validation-errors">
        <div class="error-card">
          <h3><i class="fas fa-exclamation-triangle"></i> {{ 'PAGES.CHECKOUT.DETECTED_ISSUES' | translate }}:</h3>
          <ul>
            @for (error of validationErrors(); track error.listing_id) {
              <li>{{ error.message }}</li>
            }
          </ul>
        </div>
      </div>
    }
  }
</div>