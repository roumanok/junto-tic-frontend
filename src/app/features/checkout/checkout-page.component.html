<div class="checkout-wrapper">
  @if (!product()) {
    <!-- Sin producto -->
    <div class="empty-state">
      <mat-icon class="empty-icon">shopping_cart</mat-icon>
      <h2>No hay producto seleccionado</h2>
      <p>Por favor selecciona un producto para continuar con la compra.</p>
      <button mat-raised-button color="primary" (click)="goBack()">
        <mat-icon>home</mat-icon>
        Volver al inicio
      </button>
    </div>
  } @else {
    <div class="checkout-container">
      
      <!-- COLUMNA IZQUIERDA: Resumen -->
      <div class="checkout-left">
        <div class="summary-card">
          <h2>Resumen de tu compra</h2>
          
          <!-- Producto -->
          <div class="product-item">
            <img [src]="getCdnUrl(product()!.image_url)" [alt]="product()!.title" class="product-img">
            <div class="product-details">
              <h3>{{ product()!.title }}</h3>
              <p class="product-price">$ {{ getformattedPrice(product()!.price) }}</p>
              
              <!-- Control de cantidad -->
              <div class="quantity-section">
                <label>Cantidad</label>
                <div class="quantity-controls">
                  <button type="button" class="qty-btn" (click)="decreaseQuantity()" [disabled]="quantity() <= 1">
                    -
                  </button>
                  <input type="number" 
                         [value]="quantity()" 
                         (change)="updateQuantity($event)" 
                         [max]="getMaxQuantity()"
                         min="1" 
                         class="qty-input no-spinner">
                  <button type="button" class="qty-btn" (click)="increaseQuantity()" [disabled]="quantity() >= getMaxQuantity()">
                    +
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Métodos de entrega -->
          @if (product()!.delivery_methods && product()!.delivery_methods!.length > 0) {
            <div class="delivery-section">
              <h4>Método de entrega:</h4>
              <div class="delivery-methods">
                @for (method of product()!.delivery_methods; track method.id) {
                  <label class="delivery-option">
                    <input type="radio" 
                           name="delivery_method"
                           [value]="method.id"
                           [checked]="selectedDeliveryMethod() === method.id"
                           (change)="onDeliveryMethodChange(method.id)">
                    <div class="method-content">
                      <div class="method-header">
                        <div class="method-left">
                          <i class="fas" [ngClass]="method.type === 'pickup' ? 'fa-store' : 'fa-truck'"></i>
                          <span class="method-name">{{ method.name }}</span>
                        </div>
                        <span class="method-cost">
                          {{ getMethodCost(method.cost) === 0 ? 'GRATIS' : ('$ ' + getformattedPrice(method.cost)) }}
                        </span>
                      </div>
                      @if (method.description) {
                        <p class="method-desc">{{ method.description }}</p>
                      }
                      @if (method.address) {
                        <p class="method-addr">{{ method.address }}</p>
                      }
                    </div>
                  </label>
                }
              </div>
            </div>
          }

          <hr class="divider">

          <!-- Totales -->
          <div class="totals">
            <div class="total-row">
              <span>Subtotal:</span>
              <span>$ {{ getformattedPrice(totals()?.subtotal || product()!.price) }}</span>
            </div>
            <div class="total-row">
              <span>Envío:</span>
              <span>
                @if (totals()?.shipping && getMethodCost(totals()!.shipping) > 0) {
                  $ {{ getformattedPrice(totals()!.shipping) }}
                } @else {
                  <strong style="color: #4A90A4;">GRATIS</strong>
                }
              </span>
            </div>
            <div class="total-row total-final">
              <span><strong>Total:</strong></span>
              <span><strong>$ {{ getformattedPrice(totals()?.total || (getMethodCost(product()!.price) * quantity()).toString()) }}</strong></span>
            </div>
          </div>
        </div>
      </div>

      <!-- COLUMNA DERECHA: Formulario -->
      <div class="checkout-right">
        <div class="data-card">
          <h2>Datos de la compra</h2>
          
          <form [formGroup]="checkoutForm" class="checkout-form">
            <!-- Nombre y Email -->
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Nombre completo</mat-label>
                <input matInput formControlName="customer_name">
                <mat-icon matPrefix>person</mat-icon>
                <mat-error *ngIf="checkoutForm.get('customer_name')?.hasError('required')">
                  El nombre es requerido
                </mat-error>
                <mat-error *ngIf="checkoutForm.get('customer_name')?.hasError('minlength')">
                  Mínimo 3 caracteres
                </mat-error>
              </mat-form-field>
              
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Email</mat-label>
                <input matInput formControlName="customer_email" readonly>
                <mat-icon matPrefix>email</mat-icon>
              </mat-form-field>
            </div>


            <!-- Tipo y Número de documento -->
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Tipo de documento</mat-label>
                <mat-select formControlName="customer_identification_type">
                  <mat-option value="DNI_ARG">DNI</mat-option>
                  <mat-option value="CUIT_ARG">CUIT/CUIL</mat-option>                  
                </mat-select>
                <mat-icon matPrefix>badge</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Número de documento</mat-label>
                <input matInput formControlName="customer_identification_number">
                <mat-icon matPrefix>fingerprint</mat-icon>
                <mat-error *ngIf="checkoutForm.get('customer_identification_number')?.hasError('required')">
                  El número de documento es requerido
                </mat-error>
                <mat-error *ngIf="checkoutForm.get('customer_identification_number')?.hasError('pattern')">
                  Debe contener entre 7 y 11 dígitos
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Teléfono -->
            <mat-form-field appearance="outline" class="form-field full-width">
              <mat-label>Teléfono</mat-label>
              <input matInput formControlName="customer_phone">
              <mat-icon matPrefix>phone</mat-icon>
              <mat-error *ngIf="checkoutForm.get('customer_phone')?.hasError('required')">
                El teléfono es requerido
              </mat-error>
              <mat-error *ngIf="checkoutForm.get('customer_phone')?.hasError('pattern')">
                Formato inválido (ej: +54 9 11 1234-5678)
              </mat-error>
            </mat-form-field>

            <!-- Dirección -->
            <mat-form-field appearance="outline" class="form-field full-width">
              <mat-label>Dirección de entrega</mat-label>
              <input matInput formControlName="delivery_address">
              <mat-icon matPrefix>home</mat-icon>
              <mat-error *ngIf="checkoutForm.get('delivery_address')?.hasError('required')">
                La dirección es requerida
              </mat-error>
              <mat-error *ngIf="checkoutForm.get('delivery_address')?.hasError('minlength')">
                Mínimo 5 caracteres
              </mat-error>
            </mat-form-field>

            <!-- Depto/Piso y Código Postal -->
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Depto/Piso</mat-label>
                <input matInput formControlName="delivery_apartment">
                 <mat-icon matPrefix>apartment</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Código postal</mat-label>
                <input matInput formControlName="delivery_postal_code">
                <mat-icon matPrefix>markunread_mailbox</mat-icon>
                <mat-error *ngIf="checkoutForm.get('delivery_postal_code')?.hasError('pattern')">
                  Debe ser un código postal válido (4 dígitos)
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Ciudad y Provincia -->
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Ciudad*</mat-label>
                <input matInput formControlName="delivery_city">
                <mat-icon matPrefix>location_city</mat-icon>
                <mat-error *ngIf="checkoutForm.get('delivery_city')?.hasError('required')">
                  La ciudad es requerida
                </mat-error>                
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Provincia*</mat-label>
                <mat-select formControlName="delivery_province">
                  <mat-option *ngFor="let province of provinces" [value]="province">
                    {{ province }}
                  </mat-option>
                </mat-select>
                <mat-icon matPrefix>map</mat-icon>
                <mat-error *ngIf="checkoutForm.get('delivery_province')?.hasError('required')">
                  La provincia es requerida
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Notas adicionales -->
            <mat-form-field appearance="outline" class="form-field full-width">
              <mat-label>Notas adicionales</mat-label>
              <textarea matInput 
                        formControlName="delivery_notes" 
                        rows="3"></textarea>
              <mat-icon matPrefix>note</mat-icon>
              <mat-error *ngIf="checkoutForm.get('delivery_notes')?.hasError('maxlength')">
                Máximo 500 caracteres
              </mat-error>
            </mat-form-field>

            <!-- Botones de acción -->
            <div class="action-buttons">
              <button type="button" class="btn-secondary" (click)="goBack()">
                <i class="fas fa-arrow-left"></i>
                Seguir Comprando
              </button>
              <button type="button" 
                      class="btn-primary" 
                      (click)="proceedToPayment()"
                      [disabled]="!canProceed() || !checkoutForm.valid">
                <i class="fas fa-credit-card"></i>
                Continuar al Pago
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Estados de carga -->
    @if (validating() || calculating()) {
      <div class="loading-overlay">
        <div class="spinner"></div>
        <p>{{ validating() ? 'Validando...' : 'Calculando totales...' }}</p>
      </div>
    }

    <!-- Errores de validación -->
    @if (validationErrors().length > 0) {
      <div class="validation-errors">
        <div class="error-card">
          <h3><i class="fas fa-exclamation-triangle"></i> Problemas detectados:</h3>
          <ul>
            @for (error of validationErrors(); track error.listing_id) {
              <li>{{ error.message }}</li>
            }
          </ul>
        </div>
      </div>
    }
  }
</div>